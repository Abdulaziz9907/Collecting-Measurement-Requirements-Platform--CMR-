# .github/workflows/azure-webapp.yml
name: Build and deploy API + React (Windows App Services)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  FRONTEND_DIR: Frontend/my-app
  API_URL: https://cmr-rcjy.azurewebsites.net

jobs:
  build_api:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.x"

      - name: Restore & Publish API
        run: |
          dotnet restore Commander/Commander.csproj
          dotnet publish Commander/Commander.csproj -c Release -o "${{ runner.temp }}\api_publish"

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: api
          path: ${{ runner.temp }}\api_publish

  build_web:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install & Build React (inject API URL)
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          REACT_APP_API_BASE: ${{ env.API_URL }}
        run: |
          npm ci
          npm run build

      - name: Add SPA web.config
        working-directory: ${{ env.FRONTEND_DIR }}/build
        shell: pwsh
        run: |
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <rewrite>
                <rules>
                  <rule name="StaticFiles" stopProcessing="true">
                    <match url=".*" />
                    <conditions logicalGrouping="MatchAny">
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                      <add input="{REQUEST_FILENAME}" matchType="IsDirectory" />
                    </conditions>
                    <action type="None" />
                  </rule>
                  <rule name="SpaFallback" stopProcessing="true">
                    <match url=".*" />
                    <action type="Rewrite" url="/index.html" />
                  </rule>
                </rules>
              </rewrite>
              <staticContent>
                <remove fileExtension=".json" />
                <mimeMap fileExtension=".json" mimeType="application/json" />
                <mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
                <mimeMap fileExtension=".wasm" mimeType="application/wasm" />
              </staticContent>
            </system.webServer>
          </configuration>
          "@ | Out-File -Encoding utf8 web.config

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: ${{ env.FRONTEND_DIR }}/build

  deploy_api:
    runs-on: windows-latest
    needs: build_api
    steps:
      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: api

      - name: Deploy API to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: "cmr-rcjy"
          slot-name: "Production"
          package: .
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_API }}

  deploy_web:
    runs-on: windows-latest
    needs: build_web
    steps:
      - name: Download Web artifact
        uses: actions/download-artifact@v4
        with:
          name: web

      - name: Deploy Web to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: "cmr-rcjy"
          slot-name: "Production"
          package: .
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_WEB }}
